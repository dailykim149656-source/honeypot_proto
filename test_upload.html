<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure AI Search ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        .file-input-group { margin-bottom: 20px; }
        #file-list { margin-top: 20px; }
        .file-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 4px; display: flex; align-items: center; justify-content: space-between; }
        .file-info { flex: 1; }
        .file-name { font-weight: bold; }
        .progress-bar { width: 100%; height: 20px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background-color: #3498db; width: 0%; transition: width 0.3s ease; text-align: center; color: white; font-size: 12px; line-height: 20px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; min-width: 80px; text-align: center; }
        .status-pending { background-color: #f1c40f; color: #fff; }
        .status-processing { background-color: #3498db; color: #fff; }
        .status-completed { background-color: #2ecc71; color: #fff; }
        .status-failed { background-color: #e74c3c; color: #fff; }
        button { background-color: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #34495e; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .log-area { font-family: monospace; font-size: 12px; color: #666; margin-top: 5px; max-height: 60px; overflow-y: auto; background: #f9f9f9; padding: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“‘ ë¬¸ì„œ ì—…ë¡œë“œ ë° AI Search ì¸ë±ì‹± í…ŒìŠ¤íŠ¸</h1>
        <p>ì—¬ëŸ¬ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ Azure AI Search íŒŒì´í”„ë¼ì¸(Blob -> Text -> LLM -> Search)ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
        
        <div class="file-input-group">
            <input type="file" id="files" multiple>
            <button onclick="uploadFiles()" id="uploadBtn">ì—…ë¡œë“œ ì‹œì‘</button>
        </div>

        <div id="file-list"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api/upload'; 

        async function uploadFiles() {
            const fileInput = document.getElementById('files');
            const fileListDiv = document.getElementById('file-list');
            const files = fileInput.files;

            if (files.length === 0) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('uploadBtn').disabled = true;

            // UI ì´ˆê¸°í™”
            fileListDiv.innerHTML = '';
            
            // ê° íŒŒì¼ë³„ë¡œ ì—…ë¡œë“œ ì²˜ë¦¬
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileId = `file-${i}`;
                
                // UI ìš”ì†Œ ìƒì„±
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-${fileId}">0%</div>
                        </div>
                        <div class="log-area" id="log-${fileId}">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                    <span class="status-badge status-pending" id="status-${fileId}">Pending</span>
                `;
                fileListDiv.appendChild(fileItem);

                // ê°œë³„ íŒŒì¼ ì—…ë¡œë“œ ì‹¤í–‰ (ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ì›í•˜ë©´ Promise.all ë“±ì„ ì‚¬ìš©, ì—¬ê¸°ì„œëŠ” ìˆœì°¨ì  ì‹œì‘)
                uploadSingleFile(file, fileId);
            }
        }

        async function uploadSingleFile(file, fileId) {
            const formData = new FormData();
            formData.append('file', file);

            const statusBadge = document.getElementById(`status-${fileId}`);
            const progressBar = document.getElementById(`progress-${fileId}`);
            const logArea = document.getElementById(`log-${fileId}`);

            try {
                logArea.textContent = "ì—…ë¡œë“œ ìš”ì²­ ì¤‘...";
                
                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                const data = await response.json();
                const taskId = data.task_id;
                
                logArea.textContent = `ì‘ì—… ì‹œì‘ (Task ID: ${taskId})`;
                pollStatus(taskId, fileId);

            } catch (error) {
                console.error(error);
                statusBadge.className = 'status-badge status-failed';
                statusBadge.textContent = 'Error';
                logArea.textContent = `ì—ëŸ¬: ${error.message}`;
            }
        }

        async function pollStatus(taskId, fileId) {
            const statusBadge = document.getElementById(`status-${fileId}`);
            const progressBar = document.getElementById(`progress-${fileId}`);
            const logArea = document.getElementById(`log-${fileId}`);

            const intervalId = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/status/${taskId}`);
                    if (!response.ok) {
                        throw new Error("Status check failed");
                    }

                    const task = await response.json();
                    
                    // UI ì—…ë°ì´íŠ¸
                    progressBar.style.width = `${task.progress}%`;
                    progressBar.textContent = `${task.progress}%`;
                    logArea.textContent = task.message;

                    // ìƒíƒœì— ë”°ë¥¸ ì²˜ë¦¬
                    if (task.status === 'completed' || task.status === 'completed_with_warning') {
                        clearInterval(intervalId);
                        statusBadge.className = 'status-badge status-completed';
                        statusBadge.textContent = 'Completed';
                        checkAllCompleted();
                    } else if (task.status === 'failed') {
                        clearInterval(intervalId);
                        statusBadge.className = 'status-badge status-failed';
                        statusBadge.textContent = 'Failed';
                        checkAllCompleted();
                    } else {
                        statusBadge.className = 'status-badge status-processing';
                        statusBadge.textContent = 'Processing';
                    }

                } catch (error) {
                    console.error(error);
                    clearInterval(intervalId);
                    statusBadge.className = 'status-badge status-failed';
                    statusBadge.textContent = 'Net Error';
                }
            }, 1000); // 1ì´ˆë§ˆë‹¤ í´ë§
        }

        function checkAllCompleted() {
            // ëª¨ë“  ì‘ì—…ì´ ëë‚¬ëŠ”ì§€ í™•ì¸ (ë‹¨ìˆœ êµ¬í˜„: ë²„íŠ¼ í™œì„±í™”)
            // ì‹¤ì œë¡œëŠ” ì§„í–‰ ì¤‘ì¸ ì‘ì—… ì¹´ìš´íŠ¸ë¥¼ ì„¸ëŠ” ê²ƒì´ ë” ì •í™•í•¨
            const pending = document.querySelectorAll('.status-processing, .status-pending');
            if (pending.length === 0) {
                document.getElementById('uploadBtn').disabled = false;
            }
        }
    </script>
</body>
</html>

